#!/usr/bin/env node

/**
 * Core dependencies.
 */

var fs = require('fs');
var path = require('path');

/**
 * External dependencies.
 */

var argv = require('optimist').argv;
var glob = require('glob');

/**
 * Internal dependencies.
 */

var hydro = require('..').dispatcher;

/**
 * --help.
 */

if (argv.help) {
  console.log();
  console.log('    Usage: hydro [debug] [files]');
  console.log();
  process.exit(0);
}

/**
 * --version.
 */

if (argv.version) {
  console.log(require('../package.json').version);
  process.exit(0);
}

/**
 * Formatter
 */

argv.formatter = argv.formatter || 'hydro-simple';

/**
 * Try to load the bootstrap file.
 */

var bootstrap = path.resolve(argv.setup || 'hydro.conf.js');

if (fs.existsSync(bootstrap)) {
  var setup = require(bootstrap);
  if ('function' === typeof setup) setup(hydro);
}

/**
 * Test files.
 */

argv.tests = [];

if (argv._.length === 0) {
  argv._.push('test/*.js');
}

argv._.forEach(function(pattern) {
  glob(pattern, { sync: true }).forEach(function(file) {
    if (fs.statSync(file).isDirectory()) return;
    argv.tests.push(path.resolve(file));
  });
});

/**
 * Find and run.
 */

hydro.configure(argv, function() {
  hydro.loadFormatter();
  hydro.loadTests();
  hydro.run(function(result) {
    process.exit(result.failed.length);
  });
});
