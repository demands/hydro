#!/usr/bin/env node

/**
 * Core dependencies.
 */

var fs = require('fs');
var path = require('path');

/**
 * External dependencies.
 */

var glob = require('glob');
var program = require('commander');
var load = require('refractory')(module, '../lib/mini/formatters', '{{HOME}}/.mini/formatters');

/**
 * Internal dependencies.
 */

var mini = require('..');

program
  .usage('<path-to-tests>')
  .version(require('../package.json', 'utf8').version)
  .option('--formatters', 'display all formatters')
  .option('--formatter <name>', 'specify a formatter', 'list');

program.name = 'mini';

program.on('formatters', function() {
  var dir = fs.readdirSync(path.join(__dirname, '..', 'lib', 'mini', 'formatters'));
  console.log();

  dir.filter(function(file) {
    return !/^\./.test(file);
  }).forEach(function(file) {
    console.log('    ' + file.replace(/\.js$/, ''));
  });

  console.log();
  process.exit();
});

/**
 * Parse the arguments.
 */

program.parse(process.argv);

/**
 * Glob pattern.
 */

var pattern = program.args[0] || 'test/*.test.js';

/**
 * Formatter.
 */

var Formatter = null;

try {
  Formatter = load(program.formatter);
} catch (err) {
  console.error('Bad formatter: ' + program.formatter);
  process.exit(1);
}

try {
  require(process.cwd() + '/test/mini.js');
} catch(e) {}

glob(pattern, { sync: true }, function(err, files) {
  if (err) throw err;
  files.forEach(function(file) {
    require(process.cwd() + '/' + file);
  });
});

mini.run(new Formatter, function(failures) {
  process.exit(failures.length ? 1 : 0);
});
